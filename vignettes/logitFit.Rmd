---
title: "Building a Logit Model "
author: "Christopher Weber"
output: html_document
date: "2024-09-08"
---

```{r}
```


Let's piece together how to do this in R.
```{r}
library(brms)
library(readr)
library(dplyr)
 dataActive <- read_csv("~/Dropbox/github_repos/teaching/POL683_Fall24/advancedRegression/vignettes/data/dataActive.csv", show_col_types = FALSE) %>% as.data.frame() %>%
   select(c(VIOLENT, violent, age, educ, authoritarianism, mip, moral_individualism, sdo, authoritarianism,
          ideo5, post_call, pid3))
save(dataActive, file = "~/Dropbox/github_repos/teaching/POL683_Fall24/advancedRegression/vignettes/dataActive.rda")

```
Let's try and better understand public support in Arizona for protests of an election result. How much does this support shift if the protest is framed as "violent"? We'll make use of the 2020 Western States Survey. I printed the first few rows of the data above.

Let's now recode the data and estimate a simple regression model, where support for protest is regressed on a dummy corresponding to the frame in which the respondent was randomly assigned. The dependent variable is scored "1" if the person supports election protesting; "0" if the respondent doesn't, or is neutral or unsure. The independent variable is a dummy variable, "violent", which is scored "1" if the protest is framed as violent, and "0" if the protest is framed as non-violent.  The treatment effect is the difference between these two conditions.

```{r}
setwd("~/Dropbox/github_repos/teaching/POL683_Fall24/advancedRegression/vignettes")
load("dataActive.rda")
dat = dataActive %>% 
  mutate(
    support_protest = ifelse(violent >3, 1, 0)
  ) %>%
  select(support_protest, VIOLENT)
# Estimate logit
logitModel = glm(support_protest ~ VIOLENT, data = dat, family = binomial(link = "logit")) 
# Estimate probit
probitModel = glm(support_protest ~ VIOLENT, data = dat, family = binomial(link = "probit")) 
```


Summarizing the results

```{r}
summary(logitModel)
summary(probitModel)
```

It's important to note that while the size of the coefficients changes (why), the test statistics are nearly identical. 

But what is the treatment effect? We can calculate this by taking the difference between the two conditions. 


```{r}
# Create a dataset
pred.data = expand.grid(VIOLENT = c(0, 1)) %>% as.data.frame()

predictions = predict(logitModel, pred.data,  type = "response") %>% 
  data.frame() %>%
  mutate(
    violent = c(0, 1)
  ) 
# The difference
cat("The treatment effect is",
predictions[1,1] - predictions[2,1]
)
```

There is a 12.5% decrease in the probability of supporting a protest if the protest is framed as violent.

Generating predictions with standard errors, by drawing from the variance-covariance matrix of parameters.

```{r}
library(MASS)
library(plotly)
library(tidyr)
variance = vcov(logitModel)
sim = mvrnorm(1000, coef(logitModel), variance)
sim_transformed <- sim %*% t(cbind(1, pred.data)) %>% plogis() %>% as.data.frame()
sim_transformed
names(sim_transformed) <- c("Not_specified", "Violent")

## Use ggplotly
sim_transformed %>%
  # pivot long
  pivot_longer(cols = everything(), names_to = "Violent", values_to = "Value") %>%
  group_by(Violent) %>%
  summarize(
    mean = mean(Value),
    lower = quantile(Value, 0.025),
    upper = quantile(Value, 0.975)
  )
  
```


### Generate a Plot

```{r}
library(dplyr)
library(tidyr)
library(ggridges)

sim_transformed = sim_transformed %>%
  pivot_longer(cols = everything(), names_to = "Violent", values_to = "Value") 

# Create the joyplot
sim_transformed %>%
  ggplot(aes(x = Value, y = Violent, fill = Violent)) +
  geom_density_ridges(scale = 0.9, alpha = 0.7) +
  theme_ridges() +
  labs(
    title = "Violent Framing",
    x = "Value",
    y = "Violent or Not Specified"
  ) 
```

